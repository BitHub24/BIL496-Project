# Celery ve Celery Beat ile zamanlanmış görevler için kurulum talimatları

# 1. Gerekli paketleri yükleme
pip install celery django-celery-beat

# 2. map_project/settings.py dosyasına ekleme
"""
# Celery ayarları
CELERY_BROKER_URL = 'redis://localhost:6379/0'  # veya başka bir broker
CELERY_RESULT_BACKEND = 'redis://localhost:6379/0'
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'Europe/Istanbul'

INSTALLED_APPS += [
    'django_celery_beat',
]
"""

# 3. map_project/celery.py dosyası oluştur
"""
from __future__ import absolute_import, unicode_literals
import os
from celery import Celery

# Django settings modülünü varsayılan olarak ayarla
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'map_project.settings')

app = Celery('map_project')

# Django settings'ten yapılandırma bilgisini yükle
app.config_from_object('django.conf:settings', namespace='CELERY')

# Tüm uygulamalardaki görevleri otomatik olarak yükle
app.autodiscover_tasks()
"""

# 4. map_project/__init__.py dosyasına ekle
"""
from __future__ import absolute_import, unicode_literals
from .celery import app as celery_app

__all__ = ('celery_app',)
"""

# 5. pharmacy/tasks.py dosyası oluştur
"""
from celery import shared_task
from .scrapers.ankara import get_duty_pharmacies
from .models import Pharmacy
from datetime import datetime

@shared_task
def fetch_duty_pharmacies_task():
    """Nöbetçi eczane verilerini çek ve veritabanına kaydet"""
    # Bugün için veri çek
    today = datetime.now().date()
    pharmacies_data = get_duty_pharmacies()
    
    if pharmacies_data:
        # Mevcut verileri temizle
        Pharmacy.objects.filter(date=today).delete()
        
        # Yeni verileri kaydet
        new_records = []
        for pharmacy_data in pharmacies_data:
            pharmacy = Pharmacy(
                name=pharmacy_data['Eczane Adı'],
                address=pharmacy_data['Adres'],
                phone=pharmacy_data['Telefon'],
                district=pharmacy_data['Bölge'],
                extra_info=pharmacy_data['Ek Bilgi'],
                date=datetime.strptime(pharmacy_data['Tarih'], '%Y-%m-%d').date()
            )
            new_records.append(pharmacy)
        
        Pharmacy.objects.bulk_create(new_records)
        return f"Başarıyla {len(pharmacies_data)} adet nöbetçi eczane verisi kaydedildi."
    else:
        return "Nöbetçi eczane verisi çekilemedi."
"""

# 6. Celery Beat ile zamanlanmış görevleri ayarla
# Yönetici paneline git: http://localhost:8000/admin/django_celery_beat/
# Periodic Task ekle:
# - İsim: "Nöbetçi Eczane Verilerini Çek"
# - Task: "pharmacy.tasks.fetch_duty_pharmacies_task"
# - Crontab Schedule:
#   - Dakika: 30
#   - Saat: 5
#   - Gün: *
#   - Ay: *
#   - Haftanın Günü: *

# 7. Celery ve Celery Beat'i başlat
"""
# Terminal 1'de:
celery -A map_project worker -l info

# Terminal 2'de:
celery -A map_project beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
""" 